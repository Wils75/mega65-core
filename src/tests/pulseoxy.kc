import "c64.kc"
import "print"

// Screen location
unsigned short *screen = 0xA000;
unsigned int x, y;
unsigned int n = 0;

inline void POKE(const unsigned int address, const unsigned char value)
{
  *(unsigned char*) address = value;
}

inline unsigned char PEEK(const unsigned word address)
{
  return *(unsigned char*) address;
}

struct dMagicDMAList
{
  unsigned char option_0b;
  unsigned char option_80;
  unsigned char source_mb;
  unsigned char option_81;
  unsigned char dest_mb;
  unsigned char end_of_options;

  // F018B format DMA request
  unsigned char command;
  unsigned int count;
  unsigned int source_addr;
  unsigned char source_bank;
  unsigned int dest_addr;
  unsigned char dest_bank;
  unsigned char sub_cmd;  // F018B subcmd
  unsigned int modulo;
};

struct dMagicDMAList dmaList;
unsigned char dmaByte;

void doDMA()
{
  POKE(0xd702, 0x00);
  POKE(0xd704, 0x00);
  POKE(0xd701, (unsigned char) (>(unsigned char*) &dmaList));
  POKE(0xd705, (unsigned char) (<(unsigned char*) &dmaList));
}

inline void lpoke(unsigned long address,
                  unsigned char value,
                  unsigned int count)
{
  unsigned char* charPointer = (unsigned char*) &address;
  unsigned int* intPointer = (unsigned int*) &address;

  *(unsigned char *)$0426=<&dmaList;
  *(unsigned char *)$0427=>&dmaList;

  // Smoosh two nibbles into one byte and assign
  unsigned char mega_byte = (charPointer[3] << 4) | (charPointer[2] >> 4);

  dmaList.option_0b = 0x0b;         // Unsigned char
  dmaList.option_80 = 0x80;         // Unsigned char
  dmaList.source_mb = 0;            // Unsigned char
  dmaList.option_81 = 0x81;         // Unsigned char
  dmaList.end_of_options = 0x00;

  dmaList.command = 0x00;
  dmaList.sub_cmd = 0;
  dmaList.modulo = 0;
  dmaList.count = count;
  dmaList.source_bank = 0;

  dmaList.dest_addr = (intPointer[0]);
  dmaList.dest_bank = (charPointer[2] & 0x0f);

  dmaList.dest_mb = mega_byte;         // Unsigned char
  dmaByte = value;

  dmaList.source_addr = (unsigned int) &dmaByte;
  doDMA();
}

inline void lfill(unsigned long address, unsigned char value, unsigned int count)
{
  unsigned char* charPointer = (unsigned char*) &address;
  unsigned int* intPointer = (unsigned int*) &address;

  dmaList.option_0b = 0x0b;         // Unsigned char
  dmaList.option_80 = 0x80;         // Unsigned char
  dmaList.source_mb = 0;            // Unsigned char
  dmaList.option_81 = 0x81;         // Unsigned char

  // Smoosh two nibbles into one byte and assign
  unsigned char short1 = charPointer[3];
  unsigned char short2 = charPointer[2];
  short1 = short1 << 4;
  short2 = short2 >> 4;
  unsigned char short3 = short1 | short2;
  dmaList.dest_mb = short3;         // Unsigned char

  dmaList.end_of_options = 0x00;
  dmaList.command = 0x03;
  dmaList.sub_cmd = 0;
  dmaList.count = count;
  dmaList.source_addr = value;

  unsigned int int1 = (unsigned int) intPointer[0];
  dmaList.dest_addr = int1;

  short1 = charPointer[2];
  short1 = short1 & 0x0f;

  dmaList.dest_bank = short1;

  short1 = charPointer[1];

  if (short1 >= (unsigned char) 0xd0 && short1 < (unsigned char) 0xe0)
  {

    dmaList.dest_bank |= 0x80;

  }

  doDMA();

}

void main(void)
{
  // Fast CPU
  POKE(0, 65);

  // Enable access to serial port and other devices
  POKE(53295,0x47);
  POKE(53295,0x53);

  // High res in X and Y directions
  POKE(0xd031, 0x88);

  // Set serial port speed to 9600
  POKE(0xd0e6, 0x46);
  POKE(0xd0e7, 0x10);

  // Accessing the VIC registers
  POKE(0xd02f, 0x47);
  POKE(0xd02f, 0x53);

  // Setting 16 bit character mode
  // also enable full colour chars for chars >$FF
  POKE(0xd054, 0x05);

  // Move screen to $A000
  POKE(0xD060, 0x00);
  POKE(0xD061, 0xa0);

  // Logical lines are 90 bytes long
  POKE(0xD058, 0x5a);
  POKE(0xD05E, 0x2d);

  // Make screen background black
  POKE(0xD020, 0x00);
  POKE(0xD021, 0x00);

//  lpoke(0xffd3020, 0x02);

  // Clear colour RAM and set correct bits for showing full colour chars
  lfill(0x0ff80000, 0x01, 90 * 50);

  // Initialise the screen RAM
  n = 0x1000;

  lfill((unsigned long)screen, 0, 45 * 50 * 2);

  for(x = 0; x < 1; x++)
  {
    for(y = 0; y < 50; y++)
    {
      lpoke(0x0ffd3021, 0x0c, 1);
    }
  }

  unsigned char ch = 1;

  while(1)
  {
    POKE(53280, ch);
    if(ch < 7)
    {
      ch++;
    }
    else
    {
      ch = 1;
    }
  }
}
